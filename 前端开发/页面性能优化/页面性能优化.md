资料：[页面性能](https://mp.weixin.qq.com/s/s2qq-bxn8nNb375JcZ-ZWw)

# 页面优化

- 让页面更快地显示和响应

# 页面三个阶段

## 加载阶段

- 从发出请求到渲染出完整页面的过程，影响因素主要有网络和 JavaScript 脚本
- 图片、音频、视频等文件不会阻塞页面首次渲染
- JS、首次请求的 HTML、CSS 文件会阻塞首次渲染，因为在构建 DOM 的过程中需要 HTML 和 JS，在构建渲染树过程中需要用到 CSS。这些称为关键资源。

### 三个影响页面首次渲染的核心因素

1. 关键资源的个数
2. 关键资源的大小
3. 请求关键资源需要多少个 RTT（Round Trip Time）
   - RTT：当用 TCP 协议传输一个文件时，将数据拆分成一个个数据包多次来回多次传输。RTT 就是往返时延，表示从发送端发送数据开始，到发送端收到来自接收端的确认，总共经历的时延。

### 优化方案

1. 减少关键资源个数
2. 降低关键资源大小
   - 压缩代码
3. 降低关键资源的 RTT 次数
   - 使用 CDN

## 交互阶段

- 页面加载完成到用户交互的整合过程，影响因素主要是 JavaScript 脚本
- 在交互阶段，帧的渲染速度决定了交互的流畅度。
- 大部分情况下，生成一个新的帧都是由 JS 通过修改 DOM 或 CSSOM 来触发的。还有另一部分帧是由 CSS 来触发的。

### 重排

- 在计算样式阶段发现有布局信息的修改，如元素宽高，位置等，会触发重排。然后会触发渲染流水线的一系列操作，代价较大。

### 重绘

- 在计算样式阶段发现没有布局信息的修改，只是修改了颜色一类的样式信息。跳过布局阶段，直接绘制，代价也不小。

### 合成

- 通过 CSS 实现一些变形、渐变、动画等特效，由 CSS 触发，在合成线程上执行。
- 不会触发重绘和重排，合成本身速度就非常快，所以是效率最高的方式。

### 优化

- 优化原则：让单个帧的生成速度变快

1. 减少 JS 脚本执行时间
   - JS 执行时间长，占据了主线程其他渲染任务的时间
   - 优化：
     - 将一次执行的函数分解为多个任务，使得每次执行时间不要过久
     - 利用 Web Workers，在 Web Workers 没有 DOM、CSSOM 环境，可以将一些和 DOM 操作无关且耗时的任务放到 Web Workers 中执行
2. 避免强制同步布局
3. 避免布局抖动
4. 合理利用 CSS 合成动画
5. 避免频繁的垃圾回收

## 关闭阶段

- 用户发出关闭指令后页面所做的一些清理操作
